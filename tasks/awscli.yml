---
- name: Get awscli zip file
  get_url:
    url: "{{ awscli_url }}"
    dest: "/tmp/awscliv2.zip"

- name: Check if aws cli is already installed
  command: aws --version
  ignore_errors: yes
  register: awscli_version
  changed_when: no

- name: Extract awscli
  ansible.builtin.unarchive:
    src: /tmp/awscliv2.zip
    dest: /tmp
    remote_src: yes
  changed_when: no

- name: Install aws cli ( first time )
  ansible.builtin.command: /tmp/aws/install -i /usr/local/aws-cli -b /usr/local/bin
  become: yes
  when: awscli_version.rc > 0
  become_user: root

- name: Update aws cli
  ansible.builtin.command: >-
    /tmp/aws/install -i /usr/local/aws-cli -b /usr/local/bin --update
  register: awscli_update
  become: yes
  when: awscli_version.rc == 0
  changed_when: >-
    'Skipping install' not in awscli_update.stdout
  become_user: root
